[full operational code as previously pasted]